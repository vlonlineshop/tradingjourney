<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VLCrave Express - Invoice Generator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .btn-primary {
            background: linear-gradient(135deg, #f97316 0%, #eab308 100%);
        }
        
        .invoice-modal-container {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 1rem;
        }
        
        .invoice-modal-content {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            width: 100%;
            max-width: 28rem;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }
        
        .invoice-modal-scroll {
            overflow-y: auto;
            overflow-x: hidden;
            flex: 1;
            padding: 1.5rem;
            -webkit-overflow-scrolling: touch;
        }
        
        .invoice-modal-actions {
            display: flex;
            gap: 0.5rem;
            padding: 1rem;
            border-top: 1px solid #e5e7eb;
            background: #f9fafb;
        }

        .invoice-header-orange {
            background: linear-gradient(135deg, #f97316 0%, #eab308 100%) !important;
            padding: 1.5rem;
            color: white;
        }

        .btn-orange-gradient {
            background: linear-gradient(135deg, #f97316 0%, #eab308 100%) !important;
            color: white;
            border: none;
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
        }

        .invoice-gen-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 1rem;
        }
        
        .invoice-gen-content {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            width: 100%;
            max-width: 28rem;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .invoice-gen-scroll {
            overflow-y: auto;
            overflow-x: hidden;
            flex: 1;
            padding: 1.5rem;
            -webkit-overflow-scrolling: touch;
        }
        
        .invoice-gen-footer {
            display: flex;
            gap: 0.5rem;
            padding: 1rem;
            border-top: 1px solid #e5e7eb;
            background: #f9fafb;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10001;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        .notification.success {
            background: #10b981;
            color: white;
        }
        
        .notification.error {
            background: #ef4444;
            color: white;
        }
        
        .notification.info {
            background: #3b82f6;
            color: white;
        }

        .btn-remove {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 0.5rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-add {
            background: #10b981;
            color: white;
            border: none;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 640px) {
            .invoice-modal-container,
            .invoice-gen-modal {
                padding: 0.5rem;
            }
            
            .invoice-modal-content,
            .invoice-gen-content {
                max-height: 95vh;
                max-width: 100%;
                border-radius: 0.75rem;
            }
            
            .invoice-modal-scroll,
            .invoice-gen-scroll {
                padding: 1rem;
            }
            
            .invoice-modal-actions,
            .invoice-gen-footer {
                flex-direction: column;
                padding: 0.75rem;
            }
            
            .invoice-modal-actions button,
            .invoice-gen-footer button {
                flex: 1;
                min-height: 44px;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="text-center mb-8">
            <div class="flex justify-between items-center mb-6">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-white rounded-full shadow-lg">
                    <img src="https://vlcrave.github.io/project/img/icon.png" alt="VLCrave Express" class="w-8 h-8">
                </div>
                <button onclick="app.refreshAllData()" class="bg-blue-500 hover:bg-blue-600 text-white rounded-xl px-4 py-2 font-medium flex items-center gap-2 transition-colors">
                    <i class="fas fa-sync-alt"></i>
                    Refresh Data
                </button>
            </div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">VLCrave Express</h1>
            <p class="text-gray-600">Layanan Pengiriman Premium & Invoice Generator</p>
        </header>

        <!-- Account Balances Section -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 max-w-md mx-auto">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i class="fas fa-piggy-bank text-orange-500"></i>
                Saldo Rekening
            </h2>
            <div id="accountBalances">
                <div class="text-center py-4 text-gray-500">
                    <i class="fas fa-wallet text-3xl mb-2 opacity-50"></i>
                    <p class="text-sm font-medium">Memuat saldo...</p>
                </div>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-2 gap-4 max-w-md mx-auto mb-6">
            <div class="bg-white rounded-xl p-4 shadow border-l-4 border-orange-500">
                <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center mb-2 text-orange-500">
                    <i class="fas fa-truck"></i>
                </div>
                <div class="text-xl font-bold" id="deliveryToday">0</div>
                <div class="text-xs text-gray-500 font-medium">Pengantaran Hari Ini</div>
            </div>
            <div class="bg-white rounded-xl p-4 shadow border-l-4 border-blue-500">
                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mb-2 text-blue-500">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="text-xl font-bold" id="deliveryTotal">0</div>
                <div class="text-xs text-gray-500 font-medium">Total Pengantaran</div>
            </div>
            <div class="bg-white rounded-xl p-4 shadow border-l-4 border-orange-500">
                <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center mb-2 text-orange-500">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="text-xl font-bold" id="incomeToday">Rp 0</div>
                <div class="text-xs text-gray-500 font-medium">Penghasilan Hari Ini</div>
            </div>
            <div class="bg-white rounded-xl p-4 shadow border-l-4 border-blue-500">
                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mb-2 text-blue-500">
                    <i class="fas fa-wallet"></i>
                </div>
                <div class="text-xl font-bold" id="incomeTotal">Rp 0</div>
                <div class="text-xs text-gray-500 font-medium">Total Penghasilan</div>
            </div>
        </div>

        <!-- Total Income Section -->
        <div class="bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl p-5 mb-6 shadow-lg max-w-md mx-auto">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-lg font-bold">Total Pendapatan</h2>
                    <p class="text-green-100 text-sm">Dari ongkir saja</p>
                </div>
                <i class="fas fa-money-bill-wave text-2xl"></i>
            </div>
            <div class="text-center">
                <div id="totalIncome" class="text-3xl font-bold">Rp 0</div>
                <p class="text-green-100 text-sm mt-2">Real-time update</p>
            </div>
        </div>

        <!-- Main Content -->
        <main class="max-w-md mx-auto">
            <!-- Quick Actions -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Invoice Generator</h2>
                <p class="text-gray-600 mb-6">Buat invoice dengan mudah menggunakan form input manual.</p>
                
                <button onclick="app.showInvoiceGeneratorModal()" class="btn-primary w-full flex items-center justify-center gap-2 mb-3 py-3 rounded-xl font-medium">
                    <i class="fas fa-receipt"></i>
                    Buat Invoice Manual
                </button>
            </div>

            <!-- Features -->
            <div class="grid grid-cols-2 gap-4 mb-8">
                <div class="bg-white rounded-xl p-4 text-center shadow">
                    <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-edit text-orange-500 text-xl"></i>
                    </div>
                    <h3 class="font-semibold text-gray-800 text-sm">Input Manual</h3>
                    <p class="text-xs text-gray-600 mt-1">Input produk satu per satu</p>
                </div>
                
                <div class="bg-white rounded-xl p-4 text-center shadow">
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-download text-green-500 text-xl"></i>
                    </div>
                    <h3 class="font-semibold text-gray-800 text-sm">Download PNG</h3>
                    <p class="text-xs text-gray-600 mt-1">Simpan invoice sebagai gambar</p>
                </div>
                
                <div class="bg-white rounded-xl p-4 text-center shadow">
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-share-alt text-blue-500 text-xl"></i>
                    </div>
                    <h3 class="font-semibold text-gray-800 text-sm">Share</h3>
                    <p class="text-xs text-gray-600 mt-1">Bagikan invoice dengan mudah</p>
                </div>
                
                <div class="bg-white rounded-xl p-4 text-center shadow">
                    <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-print text-purple-500 text-xl"></i>
                    </div>
                    <h3 class="font-semibold text-gray-800 text-sm">Print</h3>
                    <p class="text-xs text-gray-600 mt-1">Cetak invoice langsung</p>
                </div>
            </div>

            <!-- History Section -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">History Invoice</h2>
                    <div class="text-sm text-gray-500" id="invoiceCount">0 invoices</div>
                </div>

                <!-- History Actions -->
                <div class="flex gap-2 mb-4">
                    <button id="filterAll" class="flex-1 py-2 px-3 border border-gray-300 rounded-lg bg-orange-50 border-orange-300 text-orange-600 font-medium flex items-center justify-center gap-2" onclick="app.filterInvoices('all')">
                        <i class="fas fa-list"></i> Semua
                    </button>
                    <button id="filterToday" class="flex-1 py-2 px-3 border border-gray-300 rounded-lg bg-white text-gray-700 font-medium flex items-center justify-center gap-2" onclick="app.filterInvoices('today')">
                        <i class="fas fa-calendar-day"></i> Hari Ini
                    </button>
                    <button id="filterWeek" class="flex-1 py-2 px-3 border border-gray-300 rounded-lg bg-white text-gray-700 font-medium flex items-center justify-center gap-2" onclick="app.filterInvoices('week')">
                        <i class="fas fa-calendar-week"></i> Minggu Ini
                    </button>
                </div>

                <!-- Invoice List -->
                <div id="invoiceList" class="space-y-4">
                    <!-- Invoices will be loaded here -->
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-receipt text-3xl mb-3"></i>
                        <p>Belum ada invoice</p>
                        <p class="text-sm">Buat invoice pertama Anda</p>
                    </div>
                </div>

                <!-- Pagination -->
                <div id="pagination" class="flex justify-center items-center gap-2 mt-4 pt-4 border-t border-gray-300 hidden">
                    <!-- Pagination buttons will be generated here -->
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="text-center mt-12 text-gray-500 text-sm">
            <p>¬© 2023 VLCrave Express. All rights reserved.</p>
        </footer>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA1kevuJ9mRJ8le8uPXin11uUqJ6sOLopY",
            authDomain: "vlcrave-whatsapp-order.firebaseapp.com",
            projectId: "vlcrave-whatsapp-order",
            storageBucket: "vlcrave-whatsapp-order.firebasestorage.app",
            messagingSenderId: "796602954067",
            appId: "1:796602954067:web:e10a110ae904decdc471a6",
            measurementId: "G-XLWNDN39ZD"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // App object to hold all methods
        const app = {
            currentProducts: [],
            currentShippingCost: 0,
            currentInvoiceData: null,
            invoices: [],
            accounts: [],
            filteredInvoices: [],
            currentPage: 1,
            invoicesPerPage: 10,
            currentFilter: 'all',
            user: null,
            db: db,
            modalEscapeListener: null,
            unsubscribeIncome: null,
            unsubscribeStats: null,
            unsubscribeInvoices: null,
            unsubscribeAccounts: null,
            isRefreshing: false,

            // Initialize the app
            init() {
                console.log("VLCrave Express Invoice Generator initialized");
                
                // Tidak perlu login untuk membuat invoice
                this.user = { uid: "guest-user" };
                
                // Load existing invoices dengan snapshot real-time
                this.loadInvoicesFromFirestore();
                
                // Load accounts data
                this.loadAccountsData();
                
                // Load total income
                this.loadTotalIncome();
                
                // Load stats
                this.loadStats();
            },

            // Load accounts data dari Firestore
            loadAccountsData() {
                try {
                    this.unsubscribeAccounts = db.collection("finance_accounts")
                        .onSnapshot((snapshot) => {
                            this.accounts = [];
                            snapshot.forEach(doc => {
                                const data = doc.data();
                                data.id = doc.id;
                                this.accounts.push(data);
                            });
                            this.renderAccountBalances();
                        }, (error) => {
                            console.error("Error loading accounts:", error);
                        });
                } catch (error) {
                    console.error("Error setting up accounts listener:", error);
                }
            },

            // Render account balances
            renderAccountBalances() {
                const container = document.getElementById('accountBalances');
                
                if (this.accounts.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-4 text-gray-500">
                            <i class="fas fa-wallet text-3xl mb-2 opacity-50"></i>
                            <p class="text-sm font-medium">Belum ada rekening</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.accounts.map(account => `
                    <div class="flex justify-between items-center p-3 mb-3 rounded-xl bg-gray-50 border-l-4 ${account.type === 'tunai' ? 'border-orange-500' : account.type === 'bca' ? 'border-blue-500' : 'border-green-500'}">
                        <div>
                            <div class="font-semibold text-gray-800">${account.name}</div>
                            <div class="text-xs text-gray-500 capitalize">${account.type}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-gray-800">${this.formatCurrency(account.balance)}</div>
                        </div>
                    </div>
                `).join('');
            },

            // Update account balance di Firestore
            async updateAccountBalanceDirect(accountId, newBalance) {
                try {
                    await db.collection("finance_accounts").doc(accountId).update({
                        balance: newBalance,
                        updatedAt: new Date()
                    });
                    return true;
                } catch (error) {
                    console.error("Error updating account:", error);
                    throw error;
                }
            },

            // Refresh all data
            async refreshAllData() {
                if (this.isRefreshing) return;
                
                this.isRefreshing = true;
                const refreshBtn = document.querySelector('button[onclick="app.refreshAllData()"]');
                if (refreshBtn) {
                    refreshBtn.classList.add('loading');
                    refreshBtn.disabled = true;
                }
                
                try {
                    this.showNotification('üîÑ Memuat ulang semua data...', 'info');
                    
                    // Unsubscribe existing listeners
                    if (this.unsubscribeIncome) this.unsubscribeIncome();
                    if (this.unsubscribeStats) this.unsubscribeStats();
                    if (this.unsubscribeInvoices) this.unsubscribeInvoices();
                    if (this.unsubscribeAccounts) this.unsubscribeAccounts();
                    
                    // Clear current data
                    this.invoices = [];
                    this.filteredInvoices = [];
                    this.accounts = [];
                    
                    // Reload all data
                    this.loadInvoicesFromFirestore();
                    this.loadAccountsData();
                    this.loadTotalIncome();
                    this.loadStats();
                    
                    this.showNotification('‚úÖ Data berhasil dimuat ulang!', 'success');
                } catch (error) {
                    console.error('Error refreshing data:', error);
                    this.showNotification('‚ùå Gagal memuat ulang data', 'error');
                } finally {
                    this.isRefreshing = false;
                    if (refreshBtn) {
                        refreshBtn.classList.remove('loading');
                        refreshBtn.disabled = false;
                    }
                }
            },

            // Load total income from ongkir only
            loadTotalIncome() {
                try {
                    // Use onSnapshot for real-time updates
                    this.unsubscribeIncome = db.collection("invoices")
                        .onSnapshot((snapshot) => {
                            let totalIncome = 0;
                            snapshot.forEach((doc) => {
                                const data = doc.data();
                                if (data.shippingCost) {
                                    totalIncome += data.shippingCost;
                                }
                            });
                            
                            // Update the UI
                            const totalIncomeElement = document.getElementById('totalIncome');
                            if (totalIncomeElement) {
                                totalIncomeElement.textContent = this.formatCurrency(totalIncome);
                            }
                            
                        }, (error) => {
                            console.error("Error loading total income:", error);
                        });
                } catch (error) {
                    console.error("Error setting up income listener:", error);
                }
            },

            // Load stats for dashboard
            loadStats() {
                try {
                    this.unsubscribeStats = db.collection("invoices")
                        .onSnapshot((snapshot) => {
                            let deliveryToday = 0;
                            let deliveryTotal = 0;
                            let incomeToday = 0;
                            let incomeTotal = 0;
                            
                            // Get today's date properly
                            const now = new Date();
                            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);
                            const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                            
                            snapshot.forEach((doc) => {
                                const data = doc.data();
                                
                                // Handle date properly
                                let invoiceDate;
                                if (data.createdAt) {
                                    invoiceDate = data.createdAt.toDate();
                                } else {
                                    invoiceDate = new Date();
                                }
                                
                                // Count deliveries
                                deliveryTotal++;
                                
                                // Check if invoice is from today
                                if (invoiceDate >= todayStart && invoiceDate <= todayEnd) {
                                    deliveryToday++;
                                }
                                
                                // Calculate income
                                const shippingCost = data.shippingCost || 0;
                                incomeTotal += shippingCost;
                                if (invoiceDate >= todayStart && invoiceDate <= todayEnd) {
                                    incomeToday += shippingCost;
                                }
                            });
                            
                            // Update the UI
                            document.getElementById('deliveryToday').textContent = deliveryToday;
                            document.getElementById('deliveryTotal').textContent = deliveryTotal;
                            document.getElementById('incomeToday').textContent = this.formatCurrency(incomeToday);
                            document.getElementById('incomeTotal').textContent = this.formatCurrency(incomeTotal);
                            
                        }, (error) => {
                            console.error("Error loading stats:", error);
                        });
                } catch (error) {
                    console.error("Error setting up stats listener:", error);
                }
            },

            // Method untuk load invoices dari Firestore dengan snapshot real-time TANPA BATAS
            loadInvoicesFromFirestore() {
                try {
                    this.unsubscribeInvoices = db.collection("invoices")
                        .orderBy("createdAt", "desc")
                        // HAPUS .limit(100) untuk menghilangkan batasan
                        .onSnapshot((snapshot) => {
                            this.invoices = [];
                            snapshot.forEach((doc) => {
                                const data = doc.data();
                                data.id = doc.id;
                                this.invoices.push(data);
                            });

                            this.filteredInvoices = [...this.invoices];
                            this.renderInvoiceList();
                            
                            console.log(`‚úÖ Loaded ${this.invoices.length} invoices from Firestore`);
                            
                        }, (error) => {
                            console.error("Error loading invoices from Firestore: ", error);
                            this.showNotification('‚ùå Gagal memuat data invoice', 'error');
                        });
                } catch (error) {
                    console.error("Error setting up invoices listener: ", error);
                }
            },

            // Optimasi pagination untuk banyak data
            renderInvoiceList() {
                const invoiceList = document.getElementById('invoiceList');
                const pagination = document.getElementById('pagination');
                const invoiceCount = document.getElementById('invoiceCount');
                
                if (!invoiceList) return;

                // Update invoice count
                if (invoiceCount) {
                    invoiceCount.textContent = `${this.filteredInvoices.length} invoices`;
                }

                if (this.filteredInvoices.length === 0) {
                    invoiceList.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-receipt text-3xl mb-3"></i>
                            <p>Belum ada invoice</p>
                            <p class="text-sm">Buat invoice pertama Anda</p>
                        </div>
                    `;
                    pagination.classList.add('hidden');
                    return;
                }

                // Calculate pagination
                const totalPages = Math.ceil(this.filteredInvoices.length / this.invoicesPerPage);
                const startIndex = (this.currentPage - 1) * this.invoicesPerPage;
                const endIndex = startIndex + this.invoicesPerPage;
                const currentInvoices = this.filteredInvoices.slice(startIndex, endIndex);

                // Show loading indicator jika data banyak
                if (this.filteredInvoices.length > 100) {
                    console.log(`üîÑ Rendering ${currentInvoices.length} invoices (page ${this.currentPage} of ${totalPages})`);
                }

                // Render invoices
                invoiceList.innerHTML = currentInvoices.map(invoice => `
                    <div class="bg-white rounded-xl p-4 border border-gray-200 hover:border-orange-300 transition-colors">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <div class="font-bold text-gray-800">${invoice.invoiceNumber}</div>
                                <div class="text-sm text-gray-600">${invoice.date}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-orange-600">${this.formatCurrency(invoice.total)}</div>
                                <div class="text-xs text-gray-500 capitalize">${invoice.paymentMethod}</div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mt-4">
                            <div class="text-xs text-gray-500">
                                ${invoice.products.length} item ‚Ä¢ ${invoice.products.reduce((sum, p) => sum + p.quantity, 0)} pcs
                            </div>
                            <div class="flex gap-2">
                                <button onclick="app.viewInvoice('${invoice.invoiceNumber}')" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded-lg transition-colors">
                                    <i class="fas fa-eye mr-1"></i>Lihat
                                </button>
                                <button onclick="app.shareInvoice('${invoice.id}', '${invoice.invoiceNumber}', '${invoice.paymentMethod}', ${invoice.total})" class="text-xs bg-orange-100 hover:bg-orange-200 text-orange-700 px-3 py-1 rounded-lg transition-colors">
                                    <i class="fas fa-share-alt mr-1"></i>Share
                                </button>
                                <button onclick="app.deleteInvoice('${invoice.id}', '${invoice.invoiceNumber}')" class="text-xs bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1 rounded-lg transition-colors">
                                    <i class="fas fa-trash mr-1"></i>Hapus
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');

                // Render pagination dengan optimasi untuk banyak halaman
                if (totalPages > 1) {
                    pagination.classList.remove('hidden');
                    let paginationHTML = '';
                    
                    // Previous button
                    paginationHTML += `
                        <button onclick="app.changePage(${this.currentPage - 1})" 
                                class="w-10 h-10 flex items-center justify-center rounded-lg border border-gray-300 bg-white text-gray-700 font-medium disabled:opacity-50 disabled:cursor-not-allowed" 
                                ${this.currentPage === 1 ? 'disabled' : ''}>
                            <i class="fas fa-chevron-left text-sm"></i>
                        </button>
                    `;
                    
                    // Smart page numbers - tampilkan maksimal 7 halaman
                    let startPage = Math.max(1, this.currentPage - 3);
                    let endPage = Math.min(totalPages, startPage + 6);
                    
                    // Adjust jika di akhir
                    if (endPage - startPage < 6) {
                        startPage = Math.max(1, endPage - 6);
                    }
                    
                    // First page
                    if (startPage > 1) {
                        paginationHTML += `
                            <button onclick="app.changePage(1)" 
                                    class="w-10 h-10 flex items-center justify-center rounded-lg border border-gray-300 bg-white text-gray-700 font-medium">
                                1
                            </button>
                        `;
                        if (startPage > 2) {
                            paginationHTML += `<span class="w-10 h-10 flex items-center justify-center text-gray-500">...</span>`;
                        }
                    }
                    
                    // Page numbers
                    for (let i = startPage; i <= endPage; i++) {
                        paginationHTML += `
                            <button onclick="app.changePage(${i})" 
                                    class="w-10 h-10 flex items-center justify-center rounded-lg border ${i === this.currentPage ? 'bg-orange-500 border-orange-500 text-white' : 'border-gray-300 bg-white text-gray-700'} font-medium">
                                ${i}
                            </button>
                        `;
                    }
                    
                    // Last page
                    if (endPage < totalPages) {
                        if (endPage < totalPages - 1) {
                            paginationHTML += `<span class="w-10 h-10 flex items-center justify-center text-gray-500">...</span>`;
                        }
                        paginationHTML += `
                            <button onclick="app.changePage(${totalPages})" 
                                    class="w-10 h-10 flex items-center justify-center rounded-lg border border-gray-300 bg-white text-gray-700 font-medium">
                                ${totalPages}
                            </button>
                        `;
                    }
                    
                    // Next button
                    paginationHTML += `
                        <button onclick="app.changePage(${this.currentPage + 1})" 
                                class="w-10 h-10 flex items-center justify-center rounded-lg border border-gray-300 bg-white text-gray-700 font-medium disabled:opacity-50 disabled:cursor-not-allowed" 
                                ${this.currentPage === totalPages ? 'disabled' : ''}>
                            <i class="fas fa-chevron-right text-sm"></i>
                        </button>
                    `;
                    
                    pagination.innerHTML = paginationHTML;
                } else {
                    pagination.classList.add('hidden');
                }
            },

            // Change page for pagination
            changePage(page) {
                const totalPages = Math.ceil(this.filteredInvoices.length / this.invoicesPerPage);
                if (page < 1 || page > totalPages) return;
                
                this.currentPage = page;
                this.renderInvoiceList();
            },

            // Show invoice generator modal
            showInvoiceGeneratorModal() {
                console.log("Opening invoice generator modal");
                
                // Close any existing modals first
                this.closeInvoiceModal();

                const modal = document.createElement('div');
                
                modal.className = 'invoice-gen-modal';
                modal.innerHTML = `
                    <div class="invoice-gen-content">
                        <!-- Header -->
                        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-4 text-white">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-3">
                                    <i class="fas fa-receipt text-2xl"></i>
                                    <div>
                                        <h2 class="text-lg font-bold">Manual Invoice Generator</h2>
                                        <p class="text-indigo-200 text-xs">Input produk dan harga manual</p>
                                    </div>
                                </div>
                                <button onclick="app.closeInvoiceModal()" 
                                        class="text-white hover:text-indigo-200 transition-colors">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Scrollable Content -->
                        <div class="invoice-gen-scroll">
                            <!-- Products Section -->
                            <div class="mb-6">
                                <label class="block text-sm font-semibold text-gray-800 mb-3">
                                    <i class="fas fa-boxes text-indigo-500 mr-2"></i>
                                    Daftar Produk:
                                </label>
                                
                                <div id="productsContainer">
                                    <!-- Products will be added here -->
                                </div>
                                
                                <button onclick="app.addProduct()" class="btn-add">
                                    <i class="fas fa-plus"></i>
                                    Tambah Produk
                                </button>
                            </div>

                            <!-- Shipping Cost -->
                            <div class="mb-6">
                                <label class="block text-sm font-semibold text-gray-800 mb-3">
                                    <i class="fas fa-shipping-fast text-indigo-500 mr-2"></i>
                                    Ongkos Kirim:
                                </label>
                                <input type="number" 
                                       id="shippingCost" 
                                       placeholder="0"
                                       class="w-full border border-gray-300 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all"
                                       oninput="app.calculateTotalManual()">
                            </div>

                            <!-- Payment Method -->
                            <div class="mb-6">
                                <label class="block text-sm font-semibold text-gray-800 mb-3">
                                    <i class="fas fa-credit-card text-indigo-500 mr-2"></i>
                                    Metode Pembayaran:
                                </label>
                                <div class="grid grid-cols-2 gap-3">
                                    <label class="relative">
                                        <input type="radio" name="paymentMethod" value="tunai" class="hidden peer" checked>
                                        <div class="p-4 border-2 border-gray-300 rounded-xl text-center cursor-pointer transition-all peer-checked:border-indigo-500 peer-checked:bg-indigo-50 peer-checked:text-indigo-700 hover:border-indigo-300">
                                            <i class="fas fa-money-bill-wave text-lg mb-2"></i>
                                            <div class="font-medium">Tunai</div>
                                        </div>
                                    </label>
                                    <label class="relative">
                                        <input type="radio" name="paymentMethod" value="bca" class="hidden peer">
                                        <div class="p-4 border-2 border-gray-300 rounded-xl text-center cursor-pointer transition-all peer-checked:border-indigo-500 peer-checked:bg-indigo-50 peer-checked:text-indigo-700 hover:border-indigo-300">
                                            <i class="fas fa-university text-lg mb-2"></i>
                                            <div class="font-medium">BCA</div>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <!-- Summary -->
                            <div class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-xl p-4 border border-indigo-200">
                                <h3 class="font-semibold text-indigo-800 mb-3 text-sm uppercase tracking-wide">Ringkasan</h3>
                                <div class="space-y-2">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-indigo-700">Subtotal Produk:</span>
                                        <span id="subtotalAmount" class="font-semibold text-indigo-900">Rp 0</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-indigo-700">Ongkos Kirim:</span>
                                        <span id="shippingAmount" class="font-semibold text-indigo-900">Rp 0</span>
                                    </div>
                                    <div class="border-t border-indigo-200 pt-2 mt-2">
                                        <div class="flex justify-between items-center">
                                            <span class="font-bold text-indigo-900">Total:</span>
                                            <span id="totalAmount" class="font-bold text-lg text-indigo-600">Rp 0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div class="invoice-gen-footer">
                            <button onclick="app.closeInvoiceModal()" 
                                    class="flex-1 px-4 py-3 border border-gray-300 rounded-xl text-gray-700 hover:bg-gray-50 transition-colors font-medium">
                                <i class="fas fa-times mr-2"></i>Batal
                            </button>
                            <button onclick="app.generateManualInvoice()" 
                                    class="flex-1 px-4 py-3 bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white rounded-xl flex items-center justify-center gap-2 transition-colors font-medium">
                                <i class="fas fa-receipt"></i>
                                Buat Invoice
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
                document.body.classList.add('modal-open');

                // Initialize products
                this.currentProducts = [];
                this.addProduct();

                // Handle click outside to close
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        this.closeInvoiceModal();
                    }
                });

                // Handle escape key to close
                this.modalEscapeListener = (e) => {
                    if (e.key === 'Escape') {
                        this.closeInvoiceModal();
                    }
                };
                document.addEventListener('keydown', this.modalEscapeListener);
                
                console.log("Modal successfully opened");
            },

            // Add product input
            addProduct() {
                const productsContainer = document.getElementById('productsContainer');
                const productId = Date.now();
                
                const productHtml = `
                    <div class="flex gap-2 mb-3 items-end" id="product-${productId}">
                        <div class="flex-1">
                            <label class="block text-xs text-gray-600 mb-1">Nama Produk</label>
                            <input type="text" 
                                   placeholder="Nama produk"
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                   oninput="app.calculateTotalManual()">
                        </div>
                        <div class="w-20">
                            <label class="block text-xs text-gray-600 mb-1">Qty</label>
                            <input type="number" 
                                   value="1" 
                                   min="1"
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                   oninput="app.calculateTotalManual()">
                        </div>
                        <div class="w-28">
                            <label class="block text-xs text-gray-600 mb-1">Harga</label>
                            <input type="number" 
                                   placeholder="0"
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                   oninput="app.calculateTotalManual()">
                        </div>
                        <button type="button" onclick="app.removeProduct(${productId})" class="btn-remove">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                
                productsContainer.insertAdjacentHTML('beforeend', productHtml);
            },

            // Remove product input
            removeProduct(productId) {
                const productElement = document.getElementById(`product-${productId}`);
                if (productElement) {
                    productElement.remove();
                    this.calculateTotalManual();
                }
            },

            // Calculate total for manual input
            calculateTotalManual() {
                let subtotal = 0;
                const productElements = document.querySelectorAll('[id^="product-"]');
                
                productElements.forEach(element => {
                    const quantity = parseInt(element.querySelector('.w-20 input').value) || 0;
                    const price = parseInt(element.querySelector('.w-28 input').value) || 0;
                    subtotal += quantity * price;
                });
                
                const shippingCost = parseInt(document.getElementById('shippingCost').value) || 0;
                const total = subtotal + shippingCost;
                
                // Update display
                document.getElementById('subtotalAmount').textContent = this.formatCurrency(subtotal);
                document.getElementById('shippingAmount').textContent = this.formatCurrency(shippingCost);
                document.getElementById('totalAmount').textContent = this.formatCurrency(total);
                
                // Store current data
                this.currentProducts = Array.from(productElements).map(element => {
                    const name = element.querySelector('.flex-1 input').value || 'Produk';
                    const quantity = parseInt(element.querySelector('.w-20 input').value) || 1;
                    const price = parseInt(element.querySelector('.w-28 input').value) || 0;
                    
                    return {
                        name: name,
                        quantity: quantity,
                        price: price,
                        total: quantity * price
                    };
                });
                
                this.currentShippingCost = shippingCost;
            },

            // Generate invoice from manual input dengan update saldo rekening
            async generateManualInvoice() {
                try {
                    // Validate products
                    const validProducts = this.currentProducts.filter(product => 
                        product.name && product.name !== 'Produk' && product.price > 0
                    );
                    
                    if (validProducts.length === 0) {
                        alert('Silakan tambahkan minimal satu produk dengan harga yang valid!');
                        return;
                    }

                    // Get payment method
                    const paymentMethodRadio = document.querySelector('input[name="paymentMethod"]:checked');
                    const paymentMethod = paymentMethodRadio ? paymentMethodRadio.value : 'tunai';

                    // Generate invoice number
                    const invoiceNumber = await this.generateInvoiceNumber();

                    // Calculate totals
                    const subtotal = validProducts.reduce((sum, product) => sum + product.total, 0);
                    const shippingCost = this.currentShippingCost || 0;
                    const total = subtotal + shippingCost;

                    // Generate invoice data
                    const invoiceData = {
                        products: validProducts,
                        subtotal: subtotal,
                        shippingCost: shippingCost,
                        total: total,
                        paymentMethod: paymentMethod,
                        invoiceNumber: invoiceNumber,
                        date: new Date().toLocaleDateString('id-ID'),
                        time: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })
                    };

                    // Save to Firestore dan update saldo rekening
                    await this.saveToFirestoreWithBalanceUpdate(invoiceData);
                    
                    this.showSimpleInvoice(invoiceData);

                } catch (error) {
                    console.error('Error generating invoice:', error);
                    alert('Error membuat invoice: ' + error.message);
                }
            },

            // Save to Firestore dengan update saldo rekening
            async saveToFirestoreWithBalanceUpdate(invoiceData) {
                try {
                    const firestoreData = {
                        ...invoiceData,
                        userId: "guest-user",
                        createdAt: new Date(),
                        updatedAt: new Date(),
                        status: 'completed',
                        type: 'delivery'
                    };

                    // Simpan ke Firestore - invoices
                    const invoiceRef = await db.collection("invoices").add(firestoreData);
                    
                    // UPDATE SALDO REKENING - HANYA ONGKIR YANG DITAMBAHKAN
                    const account = this.accounts.find(acc => acc.type === invoiceData.paymentMethod);
                    if (account && invoiceData.shippingCost > 0) {
                        const newBalance = account.balance + invoiceData.shippingCost;
                        await this.updateAccountBalanceDirect(account.id, newBalance);
                        console.log(`Saldo ${account.name} diperbarui: +${this.formatCurrency(invoiceData.shippingCost)}`);
                    }
                    

                    
                    this.showNotification(`‚úÖ Invoice ${invoiceData.invoiceNumber} berhasil dibuat! Saldo diperbarui.`, 'success');
                    
                } catch (error) {
                    console.error("Error saving invoice to Firestore: ", error);
                    // Tetap tampilkan invoice meskipun gagal save ke Firestore
                    this.showNotification('‚ö†Ô∏è Invoice dibuat tapi gagal disimpan ke database', 'info');
                }
            },

            // Method untuk generate nomor invoice auto-increment dengan mengambil dari Firestore
            async generateInvoiceNumber() {
                try {
                    // Ambil invoice terakhir dari Firestore untuk melanjutkan nomor urutan
                    const lastInvoiceQuery = await db.collection("invoices")
                        .orderBy("createdAt", "desc")
                        .limit(1)
                        .get();
                    
                    let nextNumber = 1;
                    
                    if (!lastInvoiceQuery.empty) {
                        const lastInvoice = lastInvoiceQuery.docs[0].data();
                        const lastInvoiceNumber = lastInvoice.invoiceNumber;
                        
                        // Extract number dari format "VLC-XXXX"
                        if (lastInvoiceNumber && lastInvoiceNumber.startsWith('VLC-')) {
                            const lastNumberStr = lastInvoiceNumber.replace('VLC-', '');
                            const lastNumber = parseInt(lastNumberStr, 10);
                            
                            if (!isNaN(lastNumber)) {
                                nextNumber = lastNumber + 1;
                            }
                        }
                    }
                    
                    // Format: VLC-0001, VLC-0002, dst
                    const nextNumberStr = nextNumber.toString().padStart(4, '0');
                    return `VLC-${nextNumberStr}`;
                    
                } catch (error) {
                    console.error('Error generating invoice number:', error);
                    // Fallback ke timestamp
                    return `VLC-${Date.now().toString().slice(-4)}`;
                }
            },

            // Close invoice modal
            closeInvoiceModal() {
                const modals = document.querySelectorAll('.invoice-gen-modal, .invoice-modal-container');
                modals.forEach(modal => {
                    modal.remove();
                });
                document.body.classList.remove('modal-open');
                
                if (this.modalEscapeListener) {
                    document.removeEventListener('keydown', this.modalEscapeListener);
                    this.modalEscapeListener = null;
                }
            },

            // Show simple invoice dengan tampilan pembayaran yang disederhanakan
            showSimpleInvoice(invoiceData) {
                const modal = document.createElement('div');

                modal.className = 'invoice-modal-container';
                modal.innerHTML = `
                    <div class="invoice-modal-content">
                        <!-- Header dengan Gradient Oranye-Kuning -->
                        <div class="invoice-header-orange">
                            <div class="text-center">
                                <div class="inline-flex items-center justify-center w-16 h-16 bg-white/20 rounded-xl backdrop-blur-sm border border-white/30 mb-4">
                                    <img src="https://vlcrave.github.io/project/img/icon.png" 
                                         alt="VLCrave Express" class="w-8 h-8">
                                </div>
                                <h1 class="text-xl font-bold">VLCrave Express</h1>
                                <p class="text-orange-100 text-sm">Layanan Pengiriman Premium</p>
                            </div>
                        </div>
                        
                        <!-- Scrollable Content Area -->
                        <div class="invoice-modal-scroll">
                            <!-- Invoice Info Card -->
                            <div class="bg-slate-50 rounded-xl p-4 mb-6 border border-slate-200">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <div class="text-xs font-semibold text-slate-500 uppercase tracking-wider">No Invoice</div>
                                        <div class="font-mono font-bold text-slate-800 text-lg tracking-wide">${invoiceData.invoiceNumber}</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Tanggal</div>
                                        <div class="font-semibold text-slate-700">${invoiceData.date}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Products Section -->
                            <div class="mb-6">
                                <div class="flex justify-between items-center mb-4 px-2">
                                    <h3 class="font-semibold text-slate-800 text-sm uppercase tracking-wide">Detail Pesanan</h3>
                                    <div class="flex gap-8 text-xs text-slate-500 font-medium">
                                        <span class="w-8 text-center">Qty</span>
                                        <span class="w-20 text-right">Harga</span>
                                    </div>
                                </div>
                                <div class="space-y-3">
                                    ${invoiceData.products.map(product => `
                                        <div class="flex justify-between items-center bg-slate-50 rounded-lg p-3 border border-slate-100 hover:border-slate-200 transition-colors">
                                            <div class="flex-1 min-w-0">
                                                <div class="font-medium text-slate-800 text-sm leading-tight truncate">${product.name}</div>
                                            </div>
                                            <div class="flex gap-8 items-center shrink-0">
                                                <span class="w-8 text-center font-semibold text-slate-700 text-sm">${product.quantity}</span>
                                                <span class="w-20 text-right font-semibold text-slate-800 text-sm">${this.formatCurrency(product.price)}</span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- Summary Card -->
                            <div class="bg-gradient-to-br from-orange-50 to-amber-50 rounded-xl p-5 mb-6 border border-orange-200">
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-orange-800 font-medium">Subtotal</span>
                                        <span class="font-semibold text-orange-800">${this.formatCurrency(invoiceData.subtotal)}</span>
                                    </div>
                                    ${invoiceData.shippingCost > 0 ? `
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-orange-800 font-medium">Biaya Pengiriman</span>
                                        <span class="font-semibold text-orange-800">${this.formatCurrency(invoiceData.shippingCost)}</span>
                                    </div>
                                    ` : ''}
                                    <div class="border-t border-orange-300 pt-3 mt-2">
                                        <div class="flex justify-between items-center">
                                            <span class="font-bold text-orange-900 text-lg">Total Pembayaran</span>
                                            <span class="font-bold text-xl text-orange-900">${this.formatCurrency(invoiceData.total)}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Payment Method - Simplified -->
                            <div class="mb-6">
                                ${invoiceData.paymentMethod === 'tunai' ? 
                                    `<div class="flex items-center gap-3 p-3 bg-orange-50 border border-orange-200 rounded-lg">
                                        <i class="fas fa-money-bill-wave text-orange-500 text-xl"></i>
                                        <div>
                                            <div class="font-semibold text-orange-800">Pembayaran Tunai</div>
                                            <div class="text-sm text-orange-600">Mohon siapkan uang pas</div>
                                        </div>
                                    </div>` :
                                    `<div class="flex items-center gap-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                        <i class="fas fa-university text-blue-500 text-xl"></i>
                                        <div>
                                            <div class="font-semibold text-blue-800">Transfer BCA</div>
                                            <div class="text-sm text-blue-600">6455106421 a/n VICKY SATRIA LINDY</div>
                                        </div>
                                    </div>`
                                }
                            </div>

                            <!-- Footer Message -->
                            <div class="text-center pt-4 border-t border-slate-200">
                                <div class="text-xs text-slate-500 font-light">
                                    Terima kasih telah memilih<br>
                                    <span class="font-semibold text-orange-600">VLCrave Express Delivery Service</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="invoice-modal-actions">
                            <button onclick="app.closeInvoiceModal()" 
                                    class="flex-1 px-4 py-3 border border-slate-300 rounded-xl text-slate-700 hover:bg-white transition-all duration-200 font-medium text-sm shadow-sm">
                                <i class="fas fa-times mr-2"></i>Tutup
                            </button>
                            <button onclick="app.shareInvoiceIOS()" 
                                    class="flex-1 px-4 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-xl flex items-center justify-center gap-2 transition-all duration-200 font-medium text-sm shadow-lg">
                                <i class="fab fa-apple mr-1"></i>
                                Bagikan iOS
                            </button>
                            <button onclick="app.downloadAsPNG()" 
                                    class="btn-orange-gradient flex-1 px-4 py-3 flex items-center justify-center gap-2">
                                <i class="fas fa-download"></i>
                                Download PNG
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
                this.currentInvoiceData = invoiceData;

                // Handle click outside to close
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        this.closeInvoiceModal();
                    }
                });

                // Handle escape key to close
                this.modalEscapeListener = (e) => {
                    if (e.key === 'Escape') {
                        this.closeInvoiceModal();
                    }
                };
                document.addEventListener('keydown', this.modalEscapeListener);
            },

            // View invoice
            viewInvoice(invoiceNumber) {
                const invoice = this.invoices.find(inv => inv.invoiceNumber === invoiceNumber);
                if (invoice) {
                    this.currentInvoiceData = invoice;
                    this.showSimpleInvoice(invoice);
                }
            },

            // Share invoice dengan pesan khusus dan permintaan review
            async shareInvoice(id, invoiceNumber, paymentMethod, total) {
                const invoice = this.invoices.find(inv => inv.id === id);
                if (!invoice) {
                    this.showNotification('‚ùå Invoice tidak ditemukan', 'error');
                    return;
                }

                try {
                    // URL untuk review
                    const reviewUrl = `https://vlcrave.github.io/project/reviews.html?id=${invoiceNumber}`;
                    
                    let shareText = '';
                    
                    if (paymentMethod === 'bca') {
                        shareText = `‚úÖ Pesanan anda telah selesai dan akan segera menuju alamat anda

Untuk pembayaran Transfer silahkan ke nomor rekening dibawah

BCA 
6455106421
a/n VICKY SATRIA LINDY
Nominal : ${this.formatCurrency(total)}

Sambil menunggu pengantaran, Anda bisa memberikan review pada layanan kami:
${reviewUrl}

Terima kasih telah mempercayai VLCrave Express!`;
                    } else {
                        shareText = `‚úÖ Pesanan anda telah selesai dan akan segera menuju alamat anda

Silahkan bayar sesuai nominal dibawah secara Tunai/Cash
Nominal : ${this.formatCurrency(total)}

Sambil menunggu pengantaran, Anda bisa memberikan review pada layanan kami:
${reviewUrl}

Terima kasih telah mempercayai VLCrave Express!`;
                    }

                    // Check if Web Share API is available
                    if (navigator.share) {
                        try {
                            await navigator.share({
                                title: `Invoice ${invoiceNumber} - VLCrave Express`,
                                text: shareText
                            });
                            this.showNotification('‚úÖ Pesan berhasil dibagikan!', 'success');
                        } catch (shareError) {
                            console.error('Error sharing:', shareError);
                            // Fallback: copy to clipboard
                            this.copyToClipboard(shareText);
                            this.showNotification('‚úÖ Pesan berhasil disalin ke clipboard!', 'success');
                        }
                    } else {
                        // Fallback: copy to clipboard
                        this.copyToClipboard(shareText);
                        this.showNotification('‚úÖ Pesan berhasil disalin ke clipboard!', 'success');
                    }
                    
                } catch (error) {
                    console.error('Error sharing invoice:', error);
                    this.showNotification('‚ùå Gagal membagikan pesan: ' + error.message, 'error');
                }
            },

            // Method untuk share di iOS - dengan gambar invoice dan permintaan review
            async shareInvoiceIOS() {
                try {
                    if (!this.currentInvoiceData) {
                        this.showNotification('‚ùå Tidak ada data invoice untuk dibagikan', 'error');
                        return;
                    }

                    const data = this.currentInvoiceData;
                    // URL untuk review
                    const reviewUrl = `https://vlcrave.github.io/project/reviews.html?id=${data.invoiceNumber}`;

                    // Buat container struk dengan styling lengkap
                    const receiptContainer = document.createElement('div');
                    receiptContainer.id = 'invoice-receipt-container';
                    receiptContainer.style.cssText = `
                        width: 380px;
                        min-height: 600px;
                        background: white;
                        padding: 25px;
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                        font-size: 13px;
                        line-height: 1.4;
                        color: #000000;
                        border: 1px solid #e2e8f0;
                        border-radius: 16px;
                        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
                        position: fixed;
                        top: -10000px;
                        left: -10000px;
                        z-index: 10000;
                        opacity: 1;
                        box-sizing: border-box;
                        overflow: hidden;
                    `;

                    // HTML content untuk receipt
                    receiptContainer.innerHTML = this.generateReceiptHTML(data);
                    document.body.appendChild(receiptContainer);

                    await new Promise(resolve => setTimeout(resolve, 300));

                    // Konversi struk ke canvas
                    const canvas = await html2canvas(receiptContainer, {
                        scale: 3,
                        useCORS: true,
                        logging: false,
                        backgroundColor: '#ffffff',
                        width: receiptContainer.offsetWidth,
                        height: receiptContainer.scrollHeight,
                        scrollX: 0,
                        scrollY: 0,
                        allowTaint: false,
                        removeContainer: true,
                        foreignObjectRendering: false,
                        imageTimeout: 10000
                    });

                    const pngData = canvas.toDataURL('image/png', 1.0);
                    const response = await fetch(pngData);
                    const blob = await response.blob();
                    const file = new File([blob], `invoice-${data.invoiceNumber}.png`, { type: 'image/png' });

                    // üßæ Buat pesan berdasarkan metode pembayaran yang SESUAI dengan permintaan review
                    let paymentText = '';
                    
                    // Gunakan paymentMethod dari data invoice yang sebenarnya
                    if (data.paymentMethod === 'bca') {
                        paymentText = 
                            `‚úÖ Pesanan anda telah selesai dan akan segera diantarkan ke rumah anda.\n\n` +
                            `üí≥ Metode: Transfer BCA\n` +
                            `üè¶ Tujuan: BCA 6455106421 a/n VICKY SATRIA LINDY\n` +
                            `üí∞ Nominal: ${this.formatCurrency(data.total)}\n\n` +
                            `Sambil menunggu pengantaran, Anda bisa memberikan review pada layanan kami:\n` +
                            `${reviewUrl}\n\n` +
                            `Silakan transfer terlebih dahulu sebelum pengiriman.\n\n` +
                            `Terima kasih telah menggunakan layanan VLCrave Express üôå`;
                    } else {
                        // Default untuk tunai
                        paymentText = 
                            `‚úÖ Pesanan anda telah selesai dan akan segera diantarkan ke rumah anda.\n\n` +
                            `üíµ Metode: Tunai\n` +
                            `Silakan siapkan uang sebesar ${this.formatCurrency(data.total)} untuk pembayaran saat barang diterima.\n\n` +
                            `Sambil menunggu pengantaran, Anda bisa memberikan review pada layanan kami:\n` +
                            `${reviewUrl}\n\n` +
                            `Terima kasih telah menggunakan layanan VLCrave Express üôå`;
                    }

                    // Cek apakah Web Share API dengan files tersedia
                    if (!navigator.share || !navigator.canShare || !navigator.canShare({ files: [file] })) {
                        throw new Error('Fitur share dengan gambar tidak didukung di browser ini');
                    }

                    // Kirim via Web Share API (iOS) dengan GAMBAR + TEKS
                    await navigator.share({
                        files: [file],
                        title: `Invoice ${data.invoiceNumber} - VLCrave Express`,
                        text: paymentText
                    });

                    this.showNotification('‚úÖ Invoice berhasil dibagikan dengan gambar!', 'success');

                    // Cleanup
                    this.cleanupReceiptContainer();

                } catch (error) {
                    console.error('Error in shareInvoiceIOS:', error);
                    
                    // Cleanup jika error
                    this.cleanupReceiptContainer();
                    
                    // Tampilkan pesan error saja
                    if (error.name === 'AbortError') {
                        this.showNotification('‚ùå Share dibatalkan oleh user', 'error');
                    } else if (error.message.includes('tidak didukung')) {
                        this.showNotification('‚ùå Browser tidak mendukung share dengan gambar', 'error');
                    } else {
                        this.showNotification('‚ùå Gagal membagikan invoice: ' + error.message, 'error');
                    }
                }
            },

            // Method downloadAsPNG
            async downloadAsPNG() {
                try {
                    if (!this.currentInvoiceData) {
                        this.showNotification('‚ùå Tidak ada data invoice untuk didownload', 'error');
                        return;
                    }

                    const data = this.currentInvoiceData;

                    // Buat container struk dengan styling lengkap
                    const receiptContainer = document.createElement('div');
                    receiptContainer.id = 'invoice-receipt-container';
                    receiptContainer.style.cssText = `
                        width: 380px;
                        min-height: 600px;
                        background: white;
                        padding: 25px;
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                        font-size: 13px;
                        line-height: 1.4;
                        color: #000000;
                        border: 1px solid #e2e8f0;
                        border-radius: 16px;
                        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
                        position: fixed;
                        top: -10000px;
                        left: -10000px;
                        z-index: 10000;
                        opacity: 1;
                        box-sizing: border-box;
                        overflow: hidden;
                    `;

                    // HTML content untuk receipt
                    receiptContainer.innerHTML = this.generateReceiptHTML(data);

                    // Tambahkan ke DOM
                    document.body.appendChild(receiptContainer);

                    // Tunggu untuk memastikan DOM terrender
                    await new Promise(resolve => setTimeout(resolve, 300));

                    // Konfigurasi html2canvas
                    const canvas = await html2canvas(receiptContainer, {
                        scale: 3,
                        useCORS: true,
                        logging: false,
                        backgroundColor: '#ffffff',
                        width: receiptContainer.offsetWidth,
                        height: receiptContainer.scrollHeight,
                        scrollX: 0,
                        scrollY: 0,
                        allowTaint: false,
                        removeContainer: true,
                        foreignObjectRendering: false,
                        imageTimeout: 10000
                    });

                    // Convert to PNG dan download
                    const pngData = canvas.toDataURL('image/png', 1.0);
                    
                    this.downloadDataURL(pngData, `invoice-${data.invoiceNumber}-${new Date().getTime()}.png`);
                    
                    // Cleanup
                    this.cleanupReceiptContainer();
                    
                    this.showNotification(`‚úÖ Invoice ${data.invoiceNumber} berhasil didownload!`, 'success');
                    
                } catch (error) {
                    console.error('Error in downloadAsPNG:', error);
                    this.showNotification('‚ùå Gagal download invoice: ' + error.message, 'error');
                    
                    // Cleanup jika error
                    this.cleanupReceiptContainer();
                }
            },

            // Helper function untuk cleanup
            cleanupReceiptContainer() {
                const container = document.getElementById('invoice-receipt-container');
                if (container) {
                    container.remove();
                }
            },

            // Helper function untuk download data URL
            downloadDataURL(dataURL, filename) {
                const link = document.createElement('a');
                link.href = dataURL;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },

            // Helper function untuk generate HTML receipt
            generateReceiptHTML(data) {
                return `
                    <!-- Header dengan Logo Asli -->
                    <div style="text-align: center; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px solid #f1f5f9; box-sizing: border-box;">
                        <div style="font-weight: 800; font-size: 18px; color: #1e293b; letter-spacing: -0.5px; margin-bottom: 4px;">
                            VLCrave Express
                        </div>
                        <div style="font-size: 11px; color: #64748b; font-weight: 500; text-transform: uppercase; letter-spacing: 1px;">
                            Delivery Service
                        </div>
                    </div>

                    <!-- Invoice Info Card -->
                    <div style="background: linear-gradient(135deg, #fef7ed 0%, #fefce8 100%); border: 1px solid #fed7aa; border-radius: 12px; padding: 16px; margin-bottom: 20px; box-sizing: border-box;">
                        <div style="display: flex; justify-content: space-between; align-items: center; box-sizing: border-box;">
                            <div style="box-sizing: border-box;">
                                <div style="font-size: 10px; color: #ea580c; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; box-sizing: border-box;">
                                    Invoice No
                                </div>
                                <div style="font-family: 'Courier New', monospace; font-weight: 800; font-size: 14px; color: #1e293b; box-sizing: border-box;">
                                    ${data.invoiceNumber}
                                </div>
                            </div>
                            <div style="text-align: right; box-sizing: border-box;">
                                <div style="font-size: 10px; color: #ea580c; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; box-sizing: border-box;">
                                    Tanggal
                                </div>
                                <div style="font-weight: 600; font-size: 12px; color: #475569; box-sizing: border-box;">
                                    ${data.date}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Products Section -->
                    <div style="margin-bottom: 20px; box-sizing: border-box;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding: 0 4px; box-sizing: border-box;">
                            <div style="font-weight: 700; font-size: 11px; color: #475569; text-transform: uppercase; letter-spacing: 0.5px; box-sizing: border-box;">
                                Detail Pesanan
                            </div>
                            <div style="display: flex; gap: 25px; font-weight: 700; font-size: 11px; color: #475569; text-transform: uppercase; letter-spacing: 0.5px; box-sizing: border-box;">
                                <span style="width: 30px; text-align: center; box-sizing: border-box;">Qty</span>
                                <span style="width: 70px; text-align: right; box-sizing: border-box;">Harga</span>
                            </div>
                        </div>

                        <div style="box-sizing: border-box;">
                            ${data.products.map(product => `
                                <div style="display: flex; justify-content: space-between; align-items: center; background: #ffffff; border: 1px solid #f1f5f9; border-radius: 8px; padding: 12px; margin-bottom: 6px; box-sizing: border-box;">
                                    <div style="flex: 1; min-width: 0; box-sizing: border-box;">
                                        <div style="font-weight: 600; font-size: 12px; color: #1e293b; margin-bottom: 2px; line-height: 1.3; box-sizing: border-box;">
                                            ${product.name}
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 25px; align-items: center; flex-shrink: 0; box-sizing: border-box;">
                                        <span style="width: 30px; text-align: center; font-weight: 700; color: #475569; font-size: 11px; box-sizing: border-box;">
                                            ${product.quantity}
                                        </span>
                                        <span style="width: 70px; text-align: right; font-weight: 700; color: #1e293b; font-size: 11px; box-sizing: border-box;">
                                            ${this.formatCurrencyNoSymbol(product.price)}
                                        </span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Payment Method - Simplified -->
                    ${data.paymentMethod === 'tunai' ? 
                        `<div style="margin-bottom: 20px; box-sizing: border-box;">
                            <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #fef7ed; border: 1px solid #fed7aa; border-radius: 8px; box-sizing: border-box;">
                                <i class="fas fa-money-bill-wave" style="color: #ea580c; font-size: 20px; box-sizing: border-box;"></i>
                                <div style="box-sizing: border-box;">
                                    <div style="font-weight: 600; font-size: 14px; color: #9a3412; box-sizing: border-box;">
                                        Pembayaran Tunai
                                    </div>
                                    <div style="font-size: 11px; color: #ea580c; font-weight: 500; box-sizing: border-box;">
                                        Mohon siapkan uang pas
                                    </div>
                                </div>
                            </div>
                        </div>` :
                        `<div style="margin-bottom: 20px; box-sizing: border-box;">
                            <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #dbeafe; border: 1px solid #93c5fd; border-radius: 8px; box-sizing: border-box;">
                                <i class="fas fa-university" style="color: #1d4ed8; font-size: 20px; box-sizing: border-box;"></i>
                                <div style="box-sizing: border-box;">
                                    <div style="font-weight: 600; font-size: 14px; color: #1e40af; box-sizing: border-box;">
                                        Transfer BCA
                                    </div>
                                    <div style="font-size: 11px; color: #1d4ed8; font-weight: 500; box-sizing: border-box;">
                                        6455106421 a/n VICKY SATRIA LINDY
                                    </div>
                                </div>
                            </div>
                        </div>`
                    }

                    <!-- Summary Card -->
                    <div style="background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border-radius: 12px; padding: 20px; margin-bottom: 20px; color: white; box-sizing: border-box;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; box-sizing: border-box;">
                            <span style="font-size: 11px; color: #cbd5e1; font-weight: 600; box-sizing: border-box;">Subtotal</span>
                            <span style="font-weight: 600; font-size: 12px; box-sizing: border-box;">${this.formatCurrencyNoSymbol(data.subtotal)}</span>
                        </div>
                        ${data.shippingCost > 0 ? `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; box-sizing: border-box;">
                            <span style="font-size: 11px; color: #cbd5e1; font-weight: 600; box-sizing: border-box;">Biaya Pengiriman</span>
                            <span style="font-weight: 600; font-size: 12px; box-sizing: border-box;">${this.formatCurrencyNoSymbol(data.shippingCost)}</span>
                        </div>
                        ` : ''}
                        <div style="border-top: 1px solid #475569; padding-top: 12px; margin-top: 8px; box-sizing: border-box;">
                            <div style="display: flex; justify-content: space-between; align-items: center; box-sizing: border-box;">
                                <span style="font-weight: 800; font-size: 14px; color: white; box-sizing: border-box;">Total Pembayaran</span>
                                <span style="font-weight: 800; font-size: 16px; color: white; box-sizing: border-box;">${this.formatCurrencyNoSymbol(data.total)}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div style="text-align: center; padding-top: 16px; border-top: 2px dashed #e2e8f0; box-sizing: border-box;">
                        <div style="font-size: 10px; color: #64748b; line-height: 1.4; margin-bottom: 8px; box-sizing: border-box;">
                            Terima kasih telah mempercayai VLCrave Express sebagai layanan pengiriman anda
                        </div>
                        <div style="font-weight: 800; font-size: 12px; color: #f97316; letter-spacing: -0.5px; box-sizing: border-box;">
                            VLCrave Express
                        </div>
                        <div style="font-size: 9px; color: #94a3b8; margin-top: 4px; box-sizing: border-box;">
                            WA : 0857-0945-8101
                        </div>
                    </div>
                `;
            },

            // Delete invoice dengan update saldo rekening
            async deleteInvoice(id, invoiceNumber) {
                if (!confirm(`Apakah Anda yakin ingin menghapus invoice ${invoiceNumber}?`)) {
                    return;
                }

                try {
                    const invoice = this.invoices.find(inv => inv.id === id);
                    if (!invoice) {
                        throw new Error('Invoice tidak ditemukan');
                    }

                    // KURANGI SALDO REKENING - HANYA ONGKIR YANG DIKURANGI
                    const account = this.accounts.find(acc => acc.type === invoice.paymentMethod);
                    if (account && invoice.shippingCost > 0) {
                        const newBalance = Math.max(0, account.balance - invoice.shippingCost);
                        await this.updateAccountBalanceDirect(account.id, newBalance);
                        console.log(`Saldo ${account.name} diperbarui: -${this.formatCurrency(invoice.shippingCost)}`);
                    }

                    await db.collection("invoices").doc(id).delete();
                    this.showNotification(`‚úÖ Invoice ${invoiceNumber} berhasil dihapus! Saldo diperbarui.`, 'success');
                    
                } catch (error) {
                    console.error('Error deleting invoice:', error);
                    this.showNotification('‚ùå Gagal menghapus invoice: ' + error.message, 'error');
                }
            },

            // Copy text to clipboard
            async copyToClipboard(text) {
                try {
                    await navigator.clipboard.writeText(text);
                    return true;
                } catch (err) {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        return true;
                    } catch (err) {
                        document.body.removeChild(textArea);
                        return false;
                    }
                }
            },

            // Method untuk show notification
            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                // Animate in
                setTimeout(() => {
                    notification.style.transform = 'translateX(0)';
                }, 100);
                
                // Auto remove setelah 3 detik
                setTimeout(() => {
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            },

            // Format currency dengan symbol
            formatCurrency(amount) {
                return new Intl.NumberFormat('id-ID', {
                    style: 'currency',
                    currency: 'IDR',
                    minimumFractionDigits: 0
                }).format(amount);
            },

            // Format currency tanpa symbol
            formatCurrencyNoSymbol(amount) {
                return new Intl.NumberFormat('id-ID').format(amount);
            },

            // Filter invoices
            filterInvoices(filterType) {
                this.currentFilter = filterType;
                this.currentPage = 1;
                
                // Update active button
                document.querySelectorAll('.flex button').forEach(btn => {
                    btn.classList.remove('bg-orange-50', 'border-orange-300', 'text-orange-600');
                    btn.classList.add('bg-white', 'border-gray-300', 'text-gray-700');
                });
                document.getElementById(`filter${filterType.charAt(0).toUpperCase() + filterType.slice(1)}`).classList.add('bg-orange-50', 'border-orange-300', 'text-orange-600');
                
                const now = new Date();
                const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);
                const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                const weekStart = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay(), 0, 0, 0, 0);
                const weekEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate() + (6 - now.getDay()), 23, 59, 59, 999);
                
                this.filteredInvoices = this.invoices.filter(invoice => {
                    let invoiceDate;
                    if (invoice.createdAt) {
                        invoiceDate = invoice.createdAt.toDate();
                    } else {
                        invoiceDate = new Date();
                    }
                    
                    switch(filterType) {
                        case 'today':
                            return invoiceDate >= todayStart && invoiceDate <= todayEnd;
                        case 'week':
                            return invoiceDate >= weekStart && invoiceDate <= weekEnd;
                        default:
                            return true;
                    }
                });
                
                this.renderInvoiceList();
            }
        };

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>
