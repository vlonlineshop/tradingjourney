<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rating VLCrave Delivery</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-messaging-compat.js"></script>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#8b5cf6',
                        secondary: '#7c3aed',
                        accent: '#ec4899',
                        success: '#10b981',
                        warning: '#f59e0b',
                        error: '#ef4444',
                        'purple-light': '#f5f3ff',
                        'pink-light': '#fdf2f8'
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'slide-left': 'slideLeft 0.4s ease-out'
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: 0 }, '100%': { opacity: 1 } },
                        slideUp: { '0%': { transform: 'translateY(10px)', opacity: 0 }, '100%': { transform: 'translateY(0)', opacity: 1 } },
                        slideLeft: { '0%': { transform: 'translateX(20px)', opacity: 0 }, '100%': { transform: 'translateX(0)', opacity: 1 } }
                    }
                }
            }
        }
    </script>
    
    <style>
        .star.selected { 
            color: #fbbf24; 
            animation: starPop 0.3s ease-out;
        }
        @keyframes starPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1.1); }
        }
        .btn-primary {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            transition: all 0.3s;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
        }
        .quick-comment-btn {
            flex-shrink: 0;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        .quick-comment-btn:hover {
            transform: translateY(-2px);
            border-color: #8b5cf6;
        }
        .quick-comment-btn.selected {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border-color: #8b5cf6;
        }
        .scroll-container {
            scrollbar-width: thin;
            scrollbar-color: #c7d2fe #f5f3ff;
        }
        .scroll-container::-webkit-scrollbar {
            height: 6px;
        }
        .scroll-container::-webkit-scrollbar-track {
            background: #f5f3ff;
            border-radius: 3px;
        }
        .scroll-container::-webkit-scrollbar-thumb {
            background: #c7d2fe;
            border-radius: 3px;
        }
        .invoice-badge {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-50 to-pink-50 font-sans">
    <div class="max-w-xl mx-auto p-4">
        <!-- Header -->
        <header class="text-center mb-6 animate-fade-in">
            <div class="inline-flex items-center justify-center w-16 h-16 mb-4 rounded-full bg-gradient-to-br from-primary to-accent shadow-lg">
                <i class="fas fa-star text-white text-2xl"></i>
            </div>
            <h1 class="text-2xl font-bold text-gray-800 mb-1">Rating VLCrave Delivery</h1>
            <p class="text-gray-600 text-sm">Beri rating untuk pengiriman Anda</p>
        </header>

        <main class="space-y-6">
            <!-- Invoice Info Card -->
            <div id="loading" class="text-center py-8">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary mb-3"></div>
                <p class="text-gray-600">Memeriksa invoice...</p>
            </div>

            <!-- Invoice Not Found -->
            <div id="invoiceNotFound" class="hidden bg-white rounded-xl p-6 text-center shadow-sm animate-slide-up">
                <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-red-500"></i>
                </div>
                <h3 class="font-bold text-gray-800 mb-2">Invoice Tidak Ditemukan</h3>
                <p class="text-gray-600 text-sm mb-4">Invoice <span id="invoiceNotFoundNumber" class="font-semibold">-</span> tidak ditemukan di sistem.</p>
                <p class="text-gray-500 text-xs">Pastikan invoice sudah terdaftar di sistem VLCrave</p>
            </div>

            <!-- Already Rated -->
            <div id="alreadyRated" class="hidden bg-white rounded-xl p-6 text-center shadow-sm animate-slide-up">
                <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-check-circle text-success"></i>
                </div>
                <h3 class="font-bold text-gray-800 mb-2">Rating Sudah Dikirim</h3>
                <p class="text-gray-600 text-sm mb-4">Invoice ini sudah mendapatkan rating.</p>
                <div class="flex items-center justify-center gap-2 text-sm text-gray-500">
                    <i class="fas fa-info-circle"></i>
                    <span>1 invoice = 1 rating</span>
                </div>
            </div>

            <!-- Invoice Details -->
            <div id="invoiceDetails" class="hidden animate-slide-up">
                <!-- Invoice Header -->
                <div class="bg-white rounded-xl p-5 mb-4 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-purple-100 flex items-center justify-center">
                                <i class="fas fa-receipt text-primary"></i>
                            </div>
                            <div>
                                <p class="text-gray-800 font-bold text-lg" id="invoiceNumber">-</p>
                                <p class="text-gray-600 text-sm" id="invoiceDate">-</p>
                            </div>
                        </div>
                        <div class="px-3 py-1 invoice-badge text-white rounded-full text-sm font-medium">
                            <span id="invoiceStatus">-</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center">
                            <p class="text-gray-600 text-sm mb-1">Total Pesanan</p>
                            <p class="text-xl font-bold text-primary" id="invoiceTotal">-</p>
                        </div>
                        <div class="text-center">
                            <p class="text-gray-600 text-sm mb-1">Items</p>
                            <p class="text-xl font-bold text-gray-800" id="invoiceItems">-</p>
                        </div>
                    </div>
                </div>

                <!-- Products -->
                <div class="bg-white rounded-xl p-5 mb-6 shadow-sm">
                    <h3 class="font-bold text-gray-800 mb-3">Detail Pesanan</h3>
                    <div id="productsList" class="space-y-3"></div>
                </div>

                <!-- Rating Section -->
                <div class="bg-white rounded-xl p-5 shadow-sm">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Beri Rating Anda</h3>
                    
                    <!-- Stars -->
                    <div class="text-center mb-6">
                        <div class="flex justify-center gap-1 mb-3">
                            <span class="star text-4xl cursor-pointer text-gray-200 hover:text-yellow-300" data-value="1">★</span>
                            <span class="star text-4xl cursor-pointer text-gray-200 hover:text-yellow-300" data-value="2">★</span>
                            <span class="star text-4xl cursor-pointer text-gray-200 hover:text-yellow-300" data-value="3">★</span>
                            <span class="star text-4xl cursor-pointer text-gray-200 hover:text-yellow-300" data-value="4">★</span>
                            <span class="star text-4xl cursor-pointer text-gray-200 hover:text-yellow-300" data-value="5">★</span>
                        </div>
                        <p id="ratingText" class="text-gray-600">Pilih rating 1-5 bintang</p>
                    </div>

                    <!-- Quick Comments (Horizontal Scroll) -->
                    <div class="mb-6">
                        <div class="flex items-center gap-2 mb-3">
                            <i class="fas fa-comment-dots text-accent"></i>
                            <p class="text-sm text-gray-700">Pilih komentar cepat:</p>
                        </div>
                        
                        <div class="scroll-container flex gap-2 overflow-x-auto pb-2">
                            <!-- Delivery Templates -->
                            <button class="quick-comment-btn px-3 py-2 bg-purple-50 text-gray-700 rounded-lg whitespace-nowrap" 
                                    data-text="Pesanan tepat waktu">
                                <i class="fas fa-clock text-purple-600 mr-1"></i>
                                Tepat Waktu
                            </button>
                            
                            <button class="quick-comment-btn px-3 py-2 bg-purple-50 text-gray-700 rounded-lg whitespace-nowrap"
                                    data-text="Pengiriman cepat dan aman">
                                <i class="fas fa-bolt text-purple-600 mr-1"></i>
                                Cepat & Aman
                            </button>
                            
                            <!-- Food Quality Templates -->
                            <button class="quick-comment-btn px-3 py-2 bg-blue-50 text-gray-700 rounded-lg whitespace-nowrap"
                                    data-text="Makanan masih hangat dan enak">
                                <i class="fas fa-utensils text-blue-600 mr-1"></i>
                                Makanan Enak
                            </button>
                            
                            <button class="quick-comment-btn px-3 py-2 bg-blue-50 text-gray-700 rounded-lg whitespace-nowrap"
                                    data-text="Pesanan lengkap dan sesuai">
                                <i class="fas fa-check-circle text-blue-600 mr-1"></i>
                                Lengkap & Sesuai
                            </button>
                            
                            <!-- Service Templates -->
                            <button class="quick-comment-btn px-3 py-2 bg-green-50 text-gray-700 rounded-lg whitespace-nowrap"
                                    data-text="Kurir ramah dan profesional">
                                <i class="fas fa-user-check text-green-600 mr-1"></i>
                                Kurir Ramah
                            </button>
                            
                            <button class="quick-comment-btn px-3 py-2 bg-green-50 text-gray-700 rounded-lg whitespace-nowrap"
                                    data-text="Pengemasan rapi">
                                <i class="fas fa-box text-green-600 mr-1"></i>
                                Kemasan Rapi
                            </button>
                            
                            <!-- Experience Templates -->
                            <button class="quick-comment-btn px-3 py-2 bg-pink-50 text-gray-700 rounded-lg whitespace-nowrap"
                                    data-text="Pengalaman memuaskan, akan order lagi">
                                <i class="fas fa-heart text-pink-600 mr-1"></i>
                                Memuaskan
                            </button>
                            
                            <button class="quick-comment-btn px-3 py-2 bg-pink-50 text-gray-700 rounded-lg whitespace-nowrap"
                                    data-text="Sangat direkomendasikan">
                                <i class="fas fa-star text-pink-600 mr-1"></i>
                                Direkomendasikan
                            </button>
                            
                            <!-- More Positive Templates -->
                            <button class="quick-comment-btn px-3 py-2 bg-yellow-50 text-gray-700 rounded-lg whitespace-nowrap"
                                    data-text="Harga worth it dengan kualitas">
                                <i class="fas fa-tag text-yellow-600 mr-1"></i>
                                Worth It
                            </button>
                            
                            <button class="quick-comment-btn px-3 py-2 bg-indigo-50 text-gray-700 rounded-lg whitespace-nowrap"
                                    data-text="Proses order mudah dan cepat">
                                <i class="fas fa-mobile-alt text-indigo-600 mr-1"></i>
                                Order Mudah
                            </button>
                        </div>
                    </div>

                    <!-- Comment Input -->
                    <div class="mb-6">
                        <label class="block text-sm text-gray-700 mb-2">
                            <i class="fas fa-edit text-accent mr-1"></i>
                            Komentar Anda (opsional)
                        </label>
                        <textarea id="reviewComment" rows="2"
                            class="w-full px-3 py-2 text-sm rounded-lg border border-gray-300 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none resize-none"
                            placeholder="Tambahkan komentar pribadi..."
                            maxlength="150"></textarea>
                        <div class="flex justify-between mt-1">
                            <p class="text-xs text-gray-500">Max 150 karakter</p>
                            <p id="charCount" class="text-xs text-gray-500">0/150</p>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button id="submitRatingBtn" class="btn-primary w-full text-white py-3 rounded-lg font-medium">
                        <i class="fas fa-paper-plane mr-2"></i>Kirim Rating
                    </button>
                </div>
            </div>

            <!-- Success Modal -->
            <div id="successModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-xl p-6 max-w-sm w-full text-center animate-slide-up">
                    <div class="w-16 h-16 rounded-full bg-gradient-to-br from-success to-green-400 flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-check text-white text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Terima Kasih!</h3>
                    <p class="text-gray-600 text-sm mb-4">Rating Anda telah dikirim.</p>
                    <div class="flex gap-2">
                        <button id="closeModal" class="flex-1 py-2 border border-gray-300 text-gray-700 rounded-lg text-sm">
                            Tutup
                        </button>
                        <button id="shareRating" class="flex-1 py-2 btn-primary text-white rounded-lg text-sm">
                            <i class="fas fa-share mr-1"></i>Bagikan
                        </button>
                    </div>
                </div>
            </div>

            <!-- Stats Section -->
            <div class="bg-white rounded-xl p-5 shadow-sm animate-slide-up">
                <div class="flex items-center gap-2 mb-4">
                    <i class="fas fa-chart-bar text-primary"></i>
                    <h3 class="font-bold text-gray-800">Statistik Rating</h3>
                </div>
                
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="text-center p-3 bg-purple-50 rounded-lg">
                        <p class="text-2xl font-bold text-primary mb-1" id="totalRatings">0</p>
                        <p class="text-gray-600 text-xs">Total Rating</p>
                    </div>
                    <div class="text-center p-3 bg-green-50 rounded-lg">
                        <p class="text-2xl font-bold text-success mb-1" id="avgRating">0.0</p>
                        <p class="text-gray-600 text-xs">Rata-rata</p>
                    </div>
                </div>

                <!-- Recent Reviews -->
                <div>
                    <div class="flex items-center justify-between mb-3">
                        <p class="text-sm text-gray-700">Rating Terbaru</p>
                        <button id="refreshBtn" class="text-primary text-sm">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    
                    <div id="reviewsContainer" class="space-y-3"></div>
                    
                    <div id="emptyReviews" class="hidden text-center py-4">
                        <i class="fas fa-comment text-gray-300 text-xl mb-2"></i>
                        <p class="text-gray-500 text-sm">Belum ada rating</p>
                    </div>
                </div>
            </div>

            <!-- Subscription Section -->
            <div class="bg-gradient-to-r from-primary to-secondary rounded-xl p-5 text-white animate-slide-up">
                <div class="flex items-start gap-3 mb-3">
                    <div class="w-10 h-10 rounded-lg bg-white/20 flex items-center justify-center">
                        <i class="fas fa-bell"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-bold mb-1">Dapatkan Notifikasi</h3>
                        <p class="text-white/90 text-sm mb-3">Info promo dan update layanan</p>
                        <button id="subscribeBtn" class="bg-white text-primary px-4 py-2 rounded-lg text-sm font-medium">
                            <i class="fas fa-bell mr-1"></i>Aktifkan
                        </button>
                        <p id="subscribeStatus" class="text-white/80 text-xs mt-2 hidden"></p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="mt-8 text-center text-gray-500 text-sm">
            <p>© 2024 VLCrave Delivery • 1 invoice = 1 rating</p>
        </footer>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA1kevuJ9mRJ8le8uPXin11uUqJ6sOLopY",
            authDomain: "vlcrave-whatsapp-order.firebaseapp.com",
            projectId: "vlcrave-whatsapp-order",
            storageBucket: "vlcrave-whatsapp-order.firebasestorage.app",
            messagingSenderId: "796602954067",
            appId: "1:796602954067:web:e10a110ae904decdc471a6",
            measurementId: "G-XLWNDN39ZD"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Get invoice from URL
        const urlParams = new URLSearchParams(window.location.search);
        const invoiceFromUrl = urlParams.get('id');
        const invoiceNumber = invoiceFromUrl ? invoiceFromUrl.trim().toUpperCase() : null;

        // State variables
        let currentInvoice = null;
        let selectedRating = 0;
        let selectedQuickComment = null;
        let allReviews = [];

        // Format currency
        function formatRupiah(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return '-';
            return dateString;
        }

        // Load invoice from URL
        async function loadInvoiceFromUrl() {
            if (!invoiceNumber) {
                showError('URL tidak valid. Format: ?id=VLC-XXXX');
                return;
            }

            // Validate format
            if (!/^VLC-\d{4}$/.test(invoiceNumber)) {
                showError('Format invoice salah. Gunakan format: VLC-XXXX');
                return;
            }

            try {
                // Check in invoices collection
                const invoiceQuery = await db.collection('invoices')
                    .where('invoiceNumber', '==', invoiceNumber)
                    .get();

                if (invoiceQuery.empty) {
                    showInvoiceNotFound();
                    return;
                }

                // Get invoice data
                invoiceQuery.forEach(doc => {
                    currentInvoice = { id: doc.id, ...doc.data() };
                });

                // Check if already reviewed
                const reviewQuery = await db.collection('public_ratings')
                    .where('invoiceNumber', '==', invoiceNumber)
                    .get();

                if (!reviewQuery.empty) {
                    showAlreadyRated();
                } else {
                    showInvoiceDetails();
                }

                // Load reviews data
                loadReviewsData();

            } catch (error) {
                console.error('Error loading invoice:', error);
                showError('Terjadi kesalahan saat memuat data');
            } finally {
                hideLoading();
            }
        }

        // Show invoice details
        function showInvoiceDetails() {
            if (!currentInvoice) return;
            
            // Update invoice info
            document.getElementById('invoiceNumber').textContent = currentInvoice.invoiceNumber;
            document.getElementById('invoiceDate').textContent = formatDate(currentInvoice.date);
            document.getElementById('invoiceStatus').textContent = currentInvoice.status === 'completed' ? 'Selesai' : currentInvoice.status;
            document.getElementById('invoiceTotal').textContent = formatRupiah(currentInvoice.total);
            
            // Update items count
            const itemCount = currentInvoice.products ? currentInvoice.products.length : 0;
            document.getElementById('invoiceItems').textContent = itemCount;
            
            // Show products
            const productsList = document.getElementById('productsList');
            productsList.innerHTML = '';
            
            if (currentInvoice.products && currentInvoice.products.length > 0) {
                currentInvoice.products.forEach((product, index) => {
                    const productEl = document.createElement('div');
                    productEl.className = 'flex justify-between items-center py-2 border-b border-gray-100 last:border-0';
                    productEl.innerHTML = `
                        <div class="flex-1">
                            <p class="font-medium text-gray-800">${product.name}</p>
                            <p class="text-sm text-gray-600">${product.quantity} × ${formatRupiah(product.price)}</p>
                        </div>
                        <p class="font-bold text-gray-800 ml-4">${formatRupiah(product.total)}</p>
                    `;
                    productsList.appendChild(productEl);
                });
            }
            
            document.getElementById('invoiceDetails').classList.remove('hidden');
        }

        // Show invoice not found
        function showInvoiceNotFound() {
            document.getElementById('invoiceNotFoundNumber').textContent = invoiceNumber;
            document.getElementById('invoiceNotFound').classList.remove('hidden');
        }

        // Show already rated
        function showAlreadyRated() {
            document.getElementById('alreadyRated').classList.remove('hidden');
        }

        // Show error
        function showError(message) {
            document.getElementById('loading').innerHTML = `
                <div class="text-center py-8">
                    <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-exclamation-triangle text-red-500"></i>
                    </div>
                    <p class="text-gray-800 mb-2">${message}</p>
                    <p class="text-gray-600 text-sm">Contoh URL yang benar:</p>
                    <p class="text-primary font-mono text-sm mt-1">...com/?id=VLC-0015</p>
                </div>
            `;
        }

        // Hide loading
        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        // Handle quick comment selection
        function handleQuickComment(button, commentText) {
            // Remove selection from all buttons
            document.querySelectorAll('.quick-comment-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Add selection to clicked button
            button.classList.add('selected');
            selectedQuickComment = commentText;
            
            // Set comment textarea
            const textarea = document.getElementById('reviewComment');
            textarea.value = commentText;
            document.getElementById('charCount').textContent = `${commentText.length}/150`;
        }

        // Submit rating
        async function submitRating() {
            if (selectedRating === 0) {
                showToast('Pilih rating terlebih dahulu', 'error');
                return;
            }

            if (!currentInvoice) {
                showToast('Invoice tidak valid', 'error');
                return;
            }

            const comment = document.getElementById('reviewComment').value.trim();
            const btn = document.getElementById('submitRatingBtn');
            
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Mengirim...';

            try {
                // Save rating
                const ratingData = {
                    invoiceNumber: currentInvoice.invoiceNumber,
                    rating: selectedRating,
                    comment: comment || null,
                    isQuickComment: selectedQuickComment === comment,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    invoiceData: {
                        total: currentInvoice.total,
                        date: currentInvoice.date,
                        products: currentInvoice.products
                    }
                };

                await db.collection('public_ratings').add(ratingData);
                
                // Show success modal
                document.getElementById('successModal').classList.remove('hidden');
                
                // Update reviews
                loadReviewsData();

            } catch (error) {
                console.error('Error submitting rating:', error);
                showToast('Gagal mengirim rating', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Load reviews data
        async function loadReviewsData() {
            try {
                const snapshot = await db.collection('public_ratings')
                    .orderBy('createdAt', 'desc')
                    .limit(5)
                    .get();
                
                allReviews = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    allReviews.push({
                        id: doc.id,
                        ...data,
                        createdAt: data.createdAt?.toDate?.() || new Date()
                    });
                });
                
                updateStats();
                displayReviews();
                
            } catch (error) {
                console.error('Error loading reviews:', error);
            }
        }

        // Update statistics
        function updateStats() {
            if (allReviews.length === 0) {
                document.getElementById('totalRatings').textContent = '0';
                document.getElementById('avgRating').textContent = '0.0';
                return;
            }
            
            document.getElementById('totalRatings').textContent = allReviews.length;
            
            // Calculate average rating
            const totalRating = allReviews.reduce((sum, review) => sum + review.rating, 0);
            const avgRating = (totalRating / allReviews.length).toFixed(1);
            document.getElementById('avgRating').textContent = avgRating;
        }

        // Display reviews
        function displayReviews() {
            const container = document.getElementById('reviewsContainer');
            
            if (allReviews.length === 0) {
                document.getElementById('emptyReviews').classList.remove('hidden');
                container.innerHTML = '';
                return;
            }
            
            document.getElementById('emptyReviews').classList.add('hidden');
            container.innerHTML = '';
            
            allReviews.forEach(review => {
                const date = new Date(review.createdAt);
                const timeAgo = getTimeAgo(date);
                
                const reviewEl = document.createElement('div');
                reviewEl.className = 'bg-gray-50 p-3 rounded-lg animate-slide-left';
                
                reviewEl.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 rounded-full bg-primary/10 flex items-center justify-center">
                                <i class="fas fa-user text-primary text-xs"></i>
                            </div>
                            <span class="text-sm font-medium text-gray-800">${review.invoiceNumber}</span>
                        </div>
                        <span class="text-xs text-gray-500">${timeAgo}</span>
                    </div>
                    
                    <div class="flex items-center gap-1 mb-2">
                        ${Array(review.rating).fill().map(() => '<i class="fas fa-star text-yellow-500 text-xs"></i>').join('')}
                        ${Array(5 - review.rating).fill().map(() => '<i class="far fa-star text-gray-300 text-xs"></i>').join('')}
                    </div>
                    
                    ${review.comment ? `
                        <p class="text-sm text-gray-700">"${review.comment}"</p>
                    ` : ''}
                `;
                
                container.appendChild(reviewEl);
            });
        }

        // Get time ago
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return 'baru saja';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m lalu`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}j lalu`;
            if (seconds < 604800) return `${Math.floor(seconds / 86400)}h lalu`;
            return date.toLocaleDateString('id-ID');
        }

        // Show toast
        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg text-white text-sm font-medium animate-slide-up ${
                type === 'error' ? 'bg-red-500' : 'bg-primary'
            }`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Load invoice from URL
            if (invoiceNumber) {
                loadInvoiceFromUrl();
            } else {
                showError('Tambahkan parameter ?id=VLC-XXXX di URL');
            }

            // Rating stars
            document.querySelectorAll('.star').forEach(star => {
                star.addEventListener('click', function() {
                    selectedRating = parseInt(this.dataset.value);
                    
                    const ratingTexts = ['Buruk', 'Cukup', 'Baik', 'Sangat Baik', 'Luar Biasa'];
                    
                    document.querySelectorAll('.star').forEach(s => {
                        const value = parseInt(s.dataset.value);
                        if (value <= selectedRating) {
                            s.classList.add('selected');
                            s.style.color = '#fbbf24';
                        } else {
                            s.classList.remove('selected');
                            s.style.color = '#e5e7eb';
                        }
                    });
                    
                    document.getElementById('ratingText').textContent = `${selectedRating}/5 - ${ratingTexts[selectedRating-1]}`;
                });
            });

            // Quick comment buttons
            document.querySelectorAll('.quick-comment-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const commentText = this.getAttribute('data-text');
                    handleQuickComment(this, commentText);
                });
            });

            // Character count
            document.getElementById('reviewComment').addEventListener('input', function() {
                document.getElementById('charCount').textContent = `${this.value.length}/150`;
                
                // Deselect quick comment if user types custom text
                if (selectedQuickComment !== this.value) {
                    selectedQuickComment = null;
                    document.querySelectorAll('.quick-comment-btn').forEach(btn => {
                        btn.classList.remove('selected');
                    });
                }
            });

            // Submit rating
            document.getElementById('submitRatingBtn').addEventListener('click', submitRating);

            // Refresh button
            document.getElementById('refreshBtn').addEventListener('click', function() {
                this.classList.add('animate-spin');
                loadReviewsData();
                setTimeout(() => {
                    this.classList.remove('animate-spin');
                }, 1000);
            });

            // Modal buttons
            document.getElementById('closeModal').addEventListener('click', function() {
                document.getElementById('successModal').classList.add('hidden');
            });

            document.getElementById('shareRating').addEventListener('click', function() {
                if (navigator.share) {
                    navigator.share({
                        title: 'Rating VLCrave Delivery',
                        text: `Saya baru saja memberikan rating ${selectedRating} bintang untuk VLCrave Delivery!`,
                        url: window.location.href
                    });
                } else {
                    navigator.clipboard.writeText(window.location.href);
                    showToast('Link disalin!', 'success');
                }
            });

            // Subscribe button
            document.getElementById('subscribeBtn').addEventListener('click', async function() {
                if (!('Notification' in window)) {
                    showToast('Browser tidak mendukung notifikasi', 'error');
                    return;
                }
                
                const permission = await Notification.requestPermission();
                
                if (permission === 'granted') {
                    this.innerHTML = '<i class="fas fa-bell-slash mr-1"></i>Aktif';
                    this.classList.add('bg-green-500', 'text-white');
                    showToast('Notifikasi diaktifkan!', 'success');
                }
            });

            // Real-time updates
            db.collection('public_ratings').onSnapshot(loadReviewsData);
        });
    </script>
</body>
</html>
